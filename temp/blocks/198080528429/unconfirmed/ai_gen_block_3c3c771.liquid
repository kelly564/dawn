{% doc %}
  @prompt
    6 video carousel de 3 par page
{% enddoc %}
{% assign ai_gen_id = block.id | replace: '_', '' | downcase %}

{% style %}
  .ai-video-carousel-{{ ai_gen_id }} {
    width: 100%;
    padding: 40px 20px;
    background-color: {{ block.settings.background_color }};
  }

  .ai-video-carousel-container-{{ ai_gen_id }} {
    max-width: {{ block.settings.container_width }}px;
    margin: 0 auto;
  }

  .ai-video-carousel-header-{{ ai_gen_id }} {
    text-align: center;
    margin-bottom: 40px;
  }

  .ai-video-carousel-title-{{ ai_gen_id }} {
    font-size: {{ block.settings.title_size }}px;
    color: {{ block.settings.title_color }};
    margin: 0 0 10px;
  }

  .ai-video-carousel-subtitle-{{ ai_gen_id }} {
    font-size: {{ block.settings.subtitle_size }}px;
    color: {{ block.settings.subtitle_color }};
    margin: 0;
  }

  .ai-video-carousel-wrapper-{{ ai_gen_id }} {
    position: relative;
  }

  .ai-video-carousel-grid-{{ ai_gen_id }} {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: {{ block.settings.gap }}px;
    margin-bottom: 30px;
  }

  .ai-video-carousel-item-{{ ai_gen_id }} {
    position: relative;
    width: 100%;
    padding-bottom: 56.25%;
    background-color: #f4f4f4;
    border-radius: {{ block.settings.video_border_radius }}px;
    overflow: hidden;
    cursor: pointer;
  }

  .ai-video-carousel-item-{{ ai_gen_id }} iframe,
  .ai-video-carousel-item-{{ ai_gen_id }} video {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: none;
  }

  .ai-video-carousel-placeholder-{{ ai_gen_id }} {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f4f4f4;
  }

  .ai-video-carousel-placeholder-{{ ai_gen_id }} svg {
    width: 60px;
    height: 60px;
    opacity: 0.3;
  }

  .ai-video-carousel-empty-state-{{ ai_gen_id }} {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 14px;
    color: #666;
    text-align: center;
    pointer-events: none;
  }

  .ai-video-carousel-controls-{{ ai_gen_id }} {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
  }

  .ai-video-carousel-button-{{ ai_gen_id }} {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: {{ block.settings.button_color }};
    color: {{ block.settings.button_icon_color }};
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.3s ease;
  }

  .ai-video-carousel-button-{{ ai_gen_id }}:hover {
    background-color: {{ block.settings.button_hover_color }};
  }

  .ai-video-carousel-button-{{ ai_gen_id }}:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .ai-video-carousel-button-{{ ai_gen_id }} svg {
    width: 24px;
    height: 24px;
  }

  .ai-video-carousel-dots-{{ ai_gen_id }} {
    display: flex;
    gap: 10px;
  }

  .ai-video-carousel-dot-{{ ai_gen_id }} {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background-color: {{ block.settings.dot_color }};
    border: none;
    cursor: pointer;
    opacity: 0.3;
    transition: opacity 0.3s ease;
  }

  .ai-video-carousel-dot-{{ ai_gen_id }}.active {
    opacity: 1;
  }

  @media screen and (max-width: 989px) {
    .ai-video-carousel-grid-{{ ai_gen_id }} {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media screen and (max-width: 749px) {
    .ai-video-carousel-grid-{{ ai_gen_id }} {
      grid-template-columns: 1fr;
    }
  }
{% endstyle %}

<video-carousel-{{ ai_gen_id }} class="ai-video-carousel-{{ ai_gen_id }}" {{ block.shopify_attributes }}>
  <div class="ai-video-carousel-container-{{ ai_gen_id }}">
    {% if block.settings.title != blank or block.settings.subtitle != blank %}
      <div class="ai-video-carousel-header-{{ ai_gen_id }}">
        {% if block.settings.title != blank %}
          <h2 class="ai-video-carousel-title-{{ ai_gen_id }}">{{ block.settings.title }}</h2>
        {% endif %}
        {% if block.settings.subtitle != blank %}
          <p class="ai-video-carousel-subtitle-{{ ai_gen_id }}">{{ block.settings.subtitle }}</p>
        {% endif %}
      </div>
    {% endif %}

    <div class="ai-video-carousel-wrapper-{{ ai_gen_id }}">
      <div class="ai-video-carousel-grid-{{ ai_gen_id }}" data-carousel-grid>
        {% for i in (1..6) %}
          {% liquid
            assign video_url_key = 'video_url_' | append: i
            assign video_url = block.settings[video_url_key]
          %}

          <div class="ai-video-carousel-item-{{ ai_gen_id }}" data-video-index="{{ forloop.index0 }}">
            {% if video_url != blank %}
              {% if video_url contains 'youtube.com' or video_url contains 'youtu.be' %}
                {% liquid
                  assign video_id = ''
                  if video_url contains 'youtube.com/watch?v='
                    assign video_id = video_url | split: 'v=' | last | split: '&' | first
                  elsif video_url contains 'youtu.be/'
                    assign video_id = video_url | split: 'youtu.be/' | last | split: '?' | first
                  endif
                %}
                {% if video_id != blank %}
                  <iframe
                    src="https://www.youtube.com/embed/{{ video_id }}"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen
                    loading="lazy"
                  ></iframe>
                {% endif %}
              {% elsif video_url contains 'vimeo.com' %}
                {% liquid
                  assign video_id = video_url | split: 'vimeo.com/' | last | split: '/' | first
                %}
                {% if video_id != blank %}
                  <iframe
                    src="https://player.vimeo.com/video/{{ video_id }}"
                    allow="autoplay; fullscreen; picture-in-picture"
                    allowfullscreen
                    loading="lazy"
                  ></iframe>
                {% endif %}
              {% endif %}
            {% else %}
              <div class="ai-video-carousel-placeholder-{{ ai_gen_id }}">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polygon points="5 3 19 12 5 21 5 3"></polygon>
                </svg>
                <div class="ai-video-carousel-empty-state-{{ ai_gen_id }}">
                  Add video URL {{ i }}
                </div>
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>

      <div class="ai-video-carousel-controls-{{ ai_gen_id }}">
        <button
          class="ai-video-carousel-button-{{ ai_gen_id }}"
          data-carousel-prev
          aria-label="Previous videos"
        >
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
        </button>

        <div class="ai-video-carousel-dots-{{ ai_gen_id }}" data-carousel-dots></div>

        <button
          class="ai-video-carousel-button-{{ ai_gen_id }}"
          data-carousel-next
          aria-label="Next videos"
        >
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="9 18 15 12 9 6"></polyline>
          </svg>
        </button>
      </div>
    </div>
  </div>
</video-carousel-{{ ai_gen_id }}>

<script>
  (function() {
    class VideoCarousel{{ ai_gen_id }} extends HTMLElement {
      constructor() {
        super();
        this.currentPage = 0;
        this.videosPerPage = 3;
        this.totalVideos = 6;
      }

      connectedCallback() {
        this.grid = this.querySelector('[data-carousel-grid]');
        this.prevButton = this.querySelector('[data-carousel-prev]');
        this.nextButton = this.querySelector('[data-carousel-next]');
        this.dotsContainer = this.querySelector('[data-carousel-dots]');
        this.items = Array.from(this.querySelectorAll('.ai-video-carousel-item-{{ ai_gen_id }}'));

        this.updateVideosPerPage();
        this.createDots();
        this.updateCarousel();
        this.setupEventListeners();
        this.setupResizeObserver();
      }

      updateVideosPerPage() {
        const width = window.innerWidth;
        if (width <= 749) {
          this.videosPerPage = 1;
        } else if (width <= 989) {
          this.videosPerPage = 2;
        } else {
          this.videosPerPage = 3;
        }
      }

      createDots() {
        this.dotsContainer.innerHTML = '';
        const totalPages = Math.ceil(this.totalVideos / this.videosPerPage);

        for (let i = 0; i < totalPages; i++) {
          const dot = document.createElement('button');
          dot.className = 'ai-video-carousel-dot-{{ ai_gen_id }}';
          dot.setAttribute('aria-label', `Go to page ${i + 1}`);
          dot.addEventListener('click', () => this.goToPage(i));
          this.dotsContainer.appendChild(dot);
        }
      }

      setupEventListeners() {
        this.prevButton.addEventListener('click', () => this.previousPage());
        this.nextButton.addEventListener('click', () => this.nextPage());
      }

      setupResizeObserver() {
        let resizeTimeout;
        window.addEventListener('resize', () => {
          clearTimeout(resizeTimeout);
          resizeTimeout = setTimeout(() => {
            const oldVideosPerPage = this.videosPerPage;
            this.updateVideosPerPage();
            if (oldVideosPerPage !== this.videosPerPage) {
              this.currentPage = 0;
              this.createDots();
              this.updateCarousel();
            }
          }, 250);
        });
      }

      goToPage(pageIndex) {
        const totalPages = Math.ceil(this.totalVideos / this.videosPerPage);
        this.currentPage = Math.max(0, Math.min(pageIndex, totalPages - 1));
        this.updateCarousel();
      }

      previousPage() {
        if (this.currentPage > 0) {
          this.currentPage--;
          this.updateCarousel();
        }
      }

      nextPage() {
        const totalPages = Math.ceil(this.totalVideos / this.videosPerPage);
        if (this.currentPage < totalPages - 1) {
          this.currentPage++;
          this.updateCarousel();
        }
      }

      updateCarousel() {
        const totalPages = Math.ceil(this.totalVideos / this.videosPerPage);
        const startIndex = this.currentPage * this.videosPerPage;
        const endIndex = startIndex + this.videosPerPage;

        this.items.forEach((item, index) => {
          if (index >= startIndex && index < endIndex) {
            item.style.display = 'block';
          } else {
            item.style.display = 'none';
          }
        });

        this.prevButton.disabled = this.currentPage === 0;
        this.nextButton.disabled = this.currentPage === totalPages - 1;

        const dots = this.dotsContainer.querySelectorAll('.ai-video-carousel-dot-{{ ai_gen_id }}');
        dots.forEach((dot, index) => {
          if (index === this.currentPage) {
            dot.classList.add('active');
          } else {
            dot.classList.remove('active');
          }
        });
      }
    }

    customElements.define('video-carousel-{{ ai_gen_id }}', VideoCarousel{{ ai_gen_id }});
  })();
</script>

{% schema %}
{
  "name": "Video carousel",
  "tag": null,
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Our videos"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Subtitle",
      "default": "Discover our latest content"
    },
    {
      "type": "header",
      "content": "Videos"
    },
    {
      "type": "paragraph",
      "content": "Add YouTube or Vimeo video URLs. 3 videos will be shown per page on desktop."
    },
    {
      "type": "url",
      "id": "video_url_1",
      "label": "Video URL 1"
    },
    {
      "type": "url",
      "id": "video_url_2",
      "label": "Video URL 2"
    },
    {
      "type": "url",
      "id": "video_url_3",
      "label": "Video URL 3"
    },
    {
      "type": "url",
      "id": "video_url_4",
      "label": "Video URL 4"
    },
    {
      "type": "url",
      "id": "video_url_5",
      "label": "Video URL 5"
    },
    {
      "type": "url",
      "id": "video_url_6",
      "label": "Video URL 6"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "range",
      "id": "container_width",
      "min": 800,
      "max": 1600,
      "step": 100,
      "unit": "px",
      "label": "Container width",
      "default": 1200
    },
    {
      "type": "range",
      "id": "gap",
      "min": 10,
      "max": 50,
      "step": 5,
      "unit": "px",
      "label": "Gap between videos",
      "default": 20
    },
    {
      "type": "range",
      "id": "video_border_radius",
      "min": 0,
      "max": 40,
      "step": 2,
      "unit": "px",
      "label": "Video border radius",
      "default": 8
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "Title",
      "default": "#121212"
    },
    {
      "type": "color",
      "id": "subtitle_color",
      "label": "Subtitle",
      "default": "#666666"
    },
    {
      "type": "color",
      "id": "button_color",
      "label": "Button background",
      "default": "#121212"
    },
    {
      "type": "color",
      "id": "button_hover_color",
      "label": "Button hover background",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "button_icon_color",
      "label": "Button icon",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "dot_color",
      "label": "Dot",
      "default": "#121212"
    },
    {
      "type": "header",
      "content": "Typography"
    },
    {
      "type": "range",
      "id": "title_size",
      "min": 20,
      "max": 60,
      "step": 2,
      "unit": "px",
      "label": "Title size",
      "default": 32
    },
    {
      "type": "range",
      "id": "subtitle_size",
      "min": 12,
      "max": 24,
      "step": 1,
      "unit": "px",
      "label": "Subtitle size",
      "default": 16
    }
  ],
  "presets": [
    {
      "name": "Video carousel"
    }
  ]
}
{% endschema %}
